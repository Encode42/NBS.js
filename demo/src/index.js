import{getElements,getLoadedInstruments,pushLoadedInstruments,getSong,setElements,setSong,getInstruments}from"./util/globals.js";import{resetSong,startSong,stopSong}from"./audio/playback.js";import{prepareSong,loadSong,generateOverviews}from"./audio/loadSong.js";import{canParse,displayProgress}from"./util/util.js";import{decodeAudioData}from"./audio/audio.js";let editor,lastLoad,structureText,fileName;function setReady(e){e?(resetSong(),getElements().button.file.export.disabled=!1,getElements().button.structure.apply.disabled=!1,getElements().button.playback.toggle.disabled=!1,getElements().button.playback.restart.disabled=!1,getElements().toggle.playback.parity.disabled=!1,editor.setReadOnly(!1)):(stopSong(),displayProgress(""),getElements().text.overview.innerHTML=null,getElements().button.file.export.disabled=!0,getElements().button.structure.apply.disabled=!0,getElements().button.playback.toggle.disabled=!0,getElements().button.playback.restart.disabled=!0,getElements().toggle.playback.looping.disabled=!0,getElements().toggle.playback.parity.disabled=!0,getElements().text.overview.innerHTML=null,editor.setReadOnly(!0))}function updateOverviews(){getElements().text.overview.innerHTML="";for(const e of generateOverviews(getSong(),getInstruments())){const t=document.createElement("tr"),n=document.createElement("td");n.innerHTML=`<strong>${e[0]}</strong>`;const a=document.createElement("td");a.innerHTML=""===e[1]||void 0===e[1]?"None":e[1],t.append(n),t.append(a),getElements().text.overview.append(t)}}async function updateSong(e){let t=0;var n;return(e=e||getSong())&&(setSong(e),n=performance.now(),await prepareSong(),e=performance.now(),t=e-n,updateOverviews()),t}function displayStructureText(e){structureText=e||structureText,structureText&&!getElements().toggle.structure.hide.checked&&editor.getValue()!==structureText&&editor.setValue(structureText,-1)}function checkEditor(){var e=editor.getValue();return e!==structureText&&canParse(e)?{changed:!0,value:structureText=e}:(displayStructureText(structureText),{changed:!1,value:structureText})}function generateSong(e){"object"!=typeof e&&canParse(e)&&(e=JSON.parse(e));var t=new NBSjs.Song;return Object.assign(t,e),t}function exportSong(){const e=generateSong(checkEditor().value);var t=e.toArrayBuffer(),t=new Blob([new Uint8Array(t)]);const n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=fileName,document.body.append(n),n.click(),n.remove()}window.addEventListener("load",()=>{for(const t of document.getElementsByTagName("*"))""===t.getAttribute("checked")&&(t.checked=!0),"file"===t.getAttribute("type")&&(t.value=null);var e={button:{file:{input:document.getElementById("file-input"),export:document.getElementById("file-export"),instruments:document.getElementById("instruments")},playback:{toggle:document.getElementById("playback-button"),restart:document.getElementById("restart-button")},structure:{apply:document.getElementById("structure-apply")}},toggle:{playback:{looping:document.getElementById("toggle-looping"),parity:document.getElementById("toggle-parity")},structure:{hide:document.getElementById("structure-hide")}},text:{file:{progress:document.getElementById("load-progress")},playback:document.getElementById("playback"),overview:document.getElementById("result-overview"),structure:{parent:document.getElementById("structure"),edit:document.getElementById("structure-editor")}}};setElements(e),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")||getElements().button.file.instruments.classList.add("visible"),ace.config.set("basePath","https://cdn.jsdelivr.net/npm/ace-builds@1.4.13/src-min/"),ace.config.setModuleUrl("ace/theme/ayu-mirage","https://cdn.jsdelivr.net/npm/ayu-ace@2.0.4/mirage.min.js"),editor=ace.edit(getElements().text.structure.edit,{mode:"ace/mode/javascript",theme:"ace/theme/ayu-mirage",maxLines:25,fontSize:"0.8em",printMargin:!1}),editor.commands.addCommand({name:"Save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:exportSong}),setReady(!1),displayProgress("Select a file."),getElements().button.file.input.addEventListener("change",async e=>{if(0!==e.target.files.length){setReady(!1),displayProgress("Loading song..."),fileName=e.target.files[0].name;const t=await loadSong({file:e.target.files[0]});t.prepareTime=await updateSong(t.song),displayStructureText(t.structureText),setReady(!0),lastLoad=`Done! Loaded song in ${Math.floor(t.loadTime)/1e3} seconds, instruments in ${Math.floor(t.prepareTime)/1e3} seconds`,displayProgress(lastLoad)}}),getElements().button.file.instruments.addEventListener("change",async e=>{if(0!==e.target.files.length){setReady(!1);try{var t=new zip.BlobReader(e.target.files[0]);const r=new zip.ZipReader(t);var n,a=await r.getEntries();const s=getLoadedInstruments();for(const o of a)!o.directory&&o.filename.match(".ogg$")&&(n=(await o.getData(new zip.Uint8ArrayWriter)).buffer,s.get(o.filename)!==n&&pushLoadedInstruments(o.filename,await decodeAudioData(n)))}catch{}getSong()&&(await updateSong(),setReady(!0),displayProgress(lastLoad))}}),getElements().button.playback.toggle.addEventListener("click",()=>{("true"===getElements().button.playback.toggle.dataset.toggled?stopSong:startSong)()}),getElements().button.playback.restart.addEventListener("click",()=>{resetSong()}),getElements().toggle.structure.hide.addEventListener("change",e=>{e.target.checked?getElements().text.structure.parent.classList.remove("visible"):(displayStructureText(),getElements().text.structure.parent.classList.add("visible"))}),getElements().button.file.export.addEventListener("click",exportSong),getElements().button.structure.apply.addEventListener("click",async()=>{var e=checkEditor();e.changed&&await updateSong(generateSong(e.value))})});