import{getElements,getSong,setElements,setSong}from"./util/globals.js";import{prepareSong,resetSong,startSong,stopSong}from"./audio/playback.js";import{loadSong}from"./audio/loadSong.js";let structureCode,setStructureCode=!1,fileName;function displayStructureCode(e){structureCode=e||structureCode,getElements().toggle.structure.highlight.checked||(setStructureCode=!0,getElements().text.structure.code.innerHTML=structureCode)}function prepareResult(e){getElements().text.overview.innerHTML=null,displayStructureCode(e)}function setReady(e){e?(prepareSong(),resetSong(),getElements().button.file.export.disabled=!1,getElements().button.playback.toggle.disabled=!1,getElements().button.playback.restart.disabled=!1,getElements().toggle.playback.parity.disabled=!1,getElements().toggle.structure.highlight.checked||(getElements().button.structure.highlight.disabled=!1)):(setStructureCode=!1,getElements().button.file.export.disabled=!0,getElements().button.playback.toggle.disabled=!0,getElements().button.playback.restart.disabled=!0,getElements().button.structure.highlight.disabled=!0,getElements().toggle.playback.looping.disabled=!0,getElements().toggle.playback.parity.disabled=!0,stopSong())}window.addEventListener("load",()=>{for(const e of document.getElementsByTagName("*"))""===e.getAttribute("checked")&&(e.checked=!0);setElements({button:{file:{input:document.getElementById("file-input"),export:document.getElementById("file-export")},playback:{toggle:document.getElementById("playback-button"),restart:document.getElementById("restart-button")},structure:{highlight:document.getElementById("highlight")}},toggle:{playback:{looping:document.getElementById("toggle-looping"),parity:document.getElementById("toggle-parity")},structure:{highlight:document.getElementById("hide-structure")}},text:{playback:document.getElementById("playback"),overview:document.getElementById("result-overview"),structure:{parent:document.getElementById("structure"),code:document.getElementById("structure-code"),highlighting:document.getElementById("highlight-status")}}}),getElements().button.file.input.value=null,prepareResult("No file selected."),setReady(!1),navigator.userAgent.includes("Firefox")||(getElements().button.structure.highlight.classList.add("visible"),getElements().text.structure.highlighting.classList.add("enabled")),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")||getElements().text.playback.classList.add("enabled"),getElements().button.file.input.addEventListener("change",async e=>{if(0!==e.target.files.length){fileName=e.target.files[0].name,setReady(!1),prepareResult("Loading...");var t=await loadSong({file:e.target.files[0]}),e=t.song;setSong(e);for(const n of t.overviews){const l=document.createElement("tr"),s=document.createElement("td");s.innerHTML=`<strong>${n[0]}</strong>`;const r=document.createElement("td");r.innerHTML=""===n[1]?"None":n[1],l.append(s),l.append(r),getElements().text.overview.append(l)}displayStructureCode(t.structureText),setReady(!0)}}),getElements().button.file.export.addEventListener("click",()=>{if(getSong()){var e=getSong().toArrayBuffer(),e=new Blob([new Uint8Array(e)]);const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=fileName,document.body.append(t),t.click(),t.remove()}}),getElements().button.playback.toggle.addEventListener("click",()=>{("true"===getElements().button.playback.toggle.dataset.toggled?stopSong:startSong)()}),getElements().button.playback.restart.addEventListener("click",()=>{resetSong()}),getElements().button.structure.highlight.addEventListener("click",()=>{const e=new Worker("src/worker/highlight.js",{type:"module"});getElements().text.structure.highlighting.classList.add("visible"),e.postMessage({code:getElements().text.structure.code.innerHTML}),e.addEventListener("message",e=>{displayStructureCode(e.data.code),getElements().text.structure.highlighting.classList.remove("visible")})}),getElements().toggle.structure.highlight.addEventListener("change",e=>{e.target.checked?(getElements().text.structure.parent.classList.remove("visible"),getElements().button.structure.highlight.disabled=!0):(setStructureCode||(getElements().text.structure.code.innerHTML=structureCode),getElements().text.structure.parent.classList.add("visible"),getElements().button.structure.highlight.disabled=!1)})});