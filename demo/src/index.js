let song,instruments,timePerTick;const instrumentMap=new Map;let elements,structureCode,setStructureCode=!1;function displayStructureCode(e){structureCode=e||structureCode,elements.toggle.structure.highlight.checked||(setStructureCode=!0,elements.text.structure.code.innerHTML=structureCode)}function prepareResult(e){elements.text.overview.innerHTML=null,displayStructureCode(e)}function setReady(e){e?(prepareSong(),resetSong(),elements.button.playback.toggle.disabled=!1,elements.button.playback.restart.disabled=!1,elements.toggle.playback.parity.disabled=!1,elements.toggle.structure.highlight.checked||(elements.button.structure.highlight.disabled=!1)):(setStructureCode=!1,elements.button.playback.toggle.disabled=!0,elements.button.playback.restart.disabled=!0,elements.button.structure.highlight.disabled=!0,elements.toggle.playback.looping.disabled=!0,elements.toggle.playback.parity.disabled=!0,stopSong())}async function prepareSong(){await Promise.all(instruments.map(t=>t.builtIn?fetch(t.audioSrc).then(e=>e.arrayBuffer()).then(e=>decodeAudioData(e)).then(e=>t.audioBuffer=e).then(()=>instrumentMap.set(t.name,t)):null)),elements.toggle.playback.looping.disabled=!song.loopEnabled,elements.toggle.playback.looping.checked=song.loopEnabled}function startSong(){stopPlaying=!1,elements.button.playback.toggle.dataset.toggled="true",playSong(timePerTick)}function stopSong(){elements.button.playback.toggle.dataset.toggled="false",stopPlaying=!0}function resetSong(){stopSong(),currentTick=-1,currentLoop=0}window.addEventListener("load",()=>{elements={button:{fileInput:document.getElementById("file-input"),playback:{toggle:document.getElementById("playback-button"),restart:document.getElementById("restart-button")},structure:{highlight:document.getElementById("highlight")}},toggle:{playback:{looping:document.getElementById("toggle-looping"),parity:document.getElementById("toggle-parity")},structure:{highlight:document.getElementById("hide-structure")}},text:{playback:document.getElementById("playback"),overview:document.getElementById("result-overview"),structure:{parent:document.getElementById("structure"),code:document.getElementById("structure-code"),highlighting:document.getElementById("highlight-status")}}},elements.button.fileInput.value=null,prepareResult("No file selected."),setReady(!1),navigator.userAgent.includes("Firefox")||(elements.button.structure.highlight.classList.add("visible"),elements.text.structure.highlighting.classList.add("enabled")),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")||elements.text.playback.classList.add("enabled"),elements.button.fileInput.addEventListener("change",e=>{if(0!==e.target.files.length){setReady(!1);const t=new Worker("src/worker/loadSong.js");prepareResult("Loading..."),t.postMessage({file:e.target.files[0]}),t.addEventListener("message",async e=>{song=e.data.song,instruments=e.data.instruments,timePerTick=e.data.timePerTick,setReady(!0);for(const t of e.data.overviews){const n=document.createElement("tr"),s=document.createElement("td");s.innerHTML=`<strong>${t[0]}</strong>`;const l=document.createElement("td");l.innerHTML=""===t[1]?"None":t[1],n.append(s),n.append(l),elements.text.overview.append(n)}displayStructureCode(e.data.structureText)})}}),elements.button.playback.toggle.addEventListener("click",()=>{("true"===elements.button.playback.toggle.dataset.toggled?stopSong:startSong)()}),elements.button.playback.restart.addEventListener("click",()=>{resetSong()}),elements.button.structure.highlight.addEventListener("click",()=>{const e=new Worker("src/worker/highlight.js",{type:"module"});elements.text.structure.highlighting.classList.add("visible"),e.postMessage({code:elements.text.structure.code.innerHTML}),e.addEventListener("message",e=>{displayStructureCode(e.data.code),elements.text.structure.highlighting.classList.remove("visible")})}),elements.toggle.structure.highlight.addEventListener("change",e=>{e.target.checked?(elements.text.structure.parent.classList.remove("visible"),elements.button.structure.highlight.disabled=!0):(setStructureCode||(elements.text.structure.code.innerHTML=structureCode),elements.text.structure.parent.classList.add("visible"),elements.button.structure.highlight.disabled=!1)})});let stopPlaying=!0,currentTick=-1,currentLoop=0;async function playSong(t){if(song)for(var n=song.layers.length;!stopPlaying;){for(let e=0;e<n;e++){var s=song.layers[e];if(!s.locked){var l=s?.notes[currentTick];if(l){let e=(l.panning+s.panning)/2,t=l.pitch;elements.toggle.playback.parity.checked&&(e=0===s.panning?l.panning:e,t-=20),playNote(l.key,instrumentMap.get(l.instrument.name),l.velocity*s.velocity/100,e,t)}}}await new Promise(e=>setTimeout(e,t)),currentTick++,currentTick===song.size&&(elements.toggle.playback.looping.checked&&(0===song.maxLoopCount||currentLoop<song.maxLoopCount)?(currentLoop++,currentTick=song.loopStartTick):resetSong())}}