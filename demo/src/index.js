import{getElements,setElements,setSong}from"./util/globals.js";import{prepareSong,resetSong,startSong,stopSong}from"./audio/playback.js";let structureCode,setStructureCode=!1;function displayStructureCode(e){structureCode=e||structureCode,getElements().toggle.structure.highlight.checked||(setStructureCode=!0,getElements().text.structure.code.innerHTML=structureCode)}function prepareResult(e){getElements().text.overview.innerHTML=null,displayStructureCode(e)}function setReady(e){e?(prepareSong(),resetSong(),getElements().button.playback.toggle.disabled=!1,getElements().button.playback.restart.disabled=!1,getElements().toggle.playback.parity.disabled=!1,getElements().toggle.structure.highlight.checked||(getElements().button.structure.highlight.disabled=!1)):(setStructureCode=!1,getElements().button.playback.toggle.disabled=!0,getElements().button.playback.restart.disabled=!0,getElements().button.structure.highlight.disabled=!0,getElements().toggle.playback.looping.disabled=!0,getElements().toggle.playback.parity.disabled=!0,stopSong())}window.addEventListener("load",()=>{setElements({button:{fileInput:document.getElementById("file-input"),playback:{toggle:document.getElementById("playback-button"),restart:document.getElementById("restart-button")},structure:{highlight:document.getElementById("highlight")}},toggle:{playback:{looping:document.getElementById("toggle-looping"),parity:document.getElementById("toggle-parity")},structure:{highlight:document.getElementById("hide-structure")}},text:{playback:document.getElementById("playback"),overview:document.getElementById("result-overview"),structure:{parent:document.getElementById("structure"),code:document.getElementById("structure-code"),highlighting:document.getElementById("highlight-status")}}}),getElements().button.fileInput.value=null,prepareResult("No file selected."),setReady(!1),navigator.userAgent.includes("Firefox")||(getElements().button.structure.highlight.classList.add("visible"),getElements().text.structure.highlighting.classList.add("enabled")),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")||getElements().text.playback.classList.add("enabled"),getElements().button.fileInput.addEventListener("change",e=>{if(0!==e.target.files.length){setReady(!1);const t=new Worker("src/worker/loadSong.js");prepareResult("Loading..."),t.postMessage({file:e.target.files[0]}),t.addEventListener("message",async e=>{setSong({song:e.data.song,instruments:e.data.instruments,timePerTick:e.data.timePerTick}),setReady(!0);for(const t of e.data.overviews){const s=document.createElement("tr"),n=document.createElement("td");n.innerHTML=`<strong>${t[0]}</strong>`;const r=document.createElement("td");r.innerHTML=""===t[1]?"None":t[1],s.append(n),s.append(r),getElements().text.overview.append(s)}displayStructureCode(e.data.structureText)})}}),getElements().button.playback.toggle.addEventListener("click",()=>{("true"===getElements().button.playback.toggle.dataset.toggled?stopSong:startSong)()}),getElements().button.playback.restart.addEventListener("click",()=>{resetSong()}),getElements().button.structure.highlight.addEventListener("click",()=>{const e=new Worker("src/worker/highlight.js",{type:"module"});getElements().text.structure.highlighting.classList.add("visible"),e.postMessage({code:getElements().text.structure.code.innerHTML}),e.addEventListener("message",e=>{displayStructureCode(e.data.code),getElements().text.structure.highlighting.classList.remove("visible")})}),getElements().toggle.structure.highlight.addEventListener("change",e=>{e.target.checked?(getElements().text.structure.parent.classList.remove("visible"),getElements().button.structure.highlight.disabled=!0):(setStructureCode||(getElements().text.structure.code.innerHTML=structureCode),getElements().text.structure.parent.classList.add("visible"),getElements().button.structure.highlight.disabled=!1)})});