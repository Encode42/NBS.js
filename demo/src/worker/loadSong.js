self.importScripts("../NBS.js"),self.importScripts("https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js");class Instrument extends NBSjs.Instrument{audioBuffer="";constructor(t,n,e){super(t,n,e),void 0!==e&&(this.audioSrc=e.audioSrc||"")}}function prependZeros(t){return Array.from({length:Math.max(3-Math.floor(t).toString().length,0)}).join("0")+t}Instrument.builtIn=[new Instrument("Harp",0,{audioSrc:"./assets/harp.ogg",builtIn:!0}),new Instrument("Double Bass",1,{audioSrc:"./assets/dbass.ogg",builtIn:!0}),new Instrument("Bass Drum",2,{audioSrc:"./assets/bdrum.ogg",builtIn:!0}),new Instrument("Snare Drum",3,{audioSrc:"./assets/sdrum.ogg",builtIn:!0}),new Instrument("Click",4,{audioSrc:"./assets/click.ogg",builtIn:!0}),new Instrument("Guitar",5,{audioSrc:"./assets/guitar.ogg",builtIn:!0}),new Instrument("Flute",6,{audioSrc:"./assets/flute.ogg",builtIn:!0}),new Instrument("Bell",7,{audioSrc:"./assets/bell.ogg",builtIn:!0}),new Instrument("Chime",8,{audioSrc:"./assets/chime.ogg",builtIn:!0}),new Instrument("Xylophone",9,{audioSrc:"./assets/xylophone.ogg",builtIn:!0}),new Instrument("Iron Xylophone",10,{audioSrc:"./assets/iron_xylophone.ogg",builtIn:!0}),new Instrument("Cow Bell",11,{audioSrc:"./assets/cow_bell.ogg",builtIn:!0}),new Instrument("Didgeridoo",12,{audioSrc:"./assets/didgeridoo.ogg",builtIn:!0}),new Instrument("Bit",13,{audioSrc:"./assets/bit.ogg",builtIn:!0}),new Instrument("Banjo",14,{audioSrc:"./assets/banjo.ogg",builtIn:!0}),new Instrument("Pling",15,{audioSrc:"./assets/pling.ogg",builtIn:!0})],NBSjs.setInstrumentClass(Instrument),self.addEventListener("message",async t=>{const n={},e=NBSjs.Song.fromArrayBuffer(await t.data.file.arrayBuffer());n.song=_.cloneDeep(e),n.timePerTick=e.timePerTick,n.instruments=e.instruments;const s=[];var r=e.layers.length;for(let t=0;t<r;t++){const i=e.layers[t],u=[];for(const a of i.notes)void 0!==a&&u.push(a);i.notes=u,0<i.notes.length&&s.push(i)}e.layers=s;t={seconds:e.timePerTick*e.size/1e3,get s(){return(this.seconds%60).toFixed(2)},get m(){return Math.floor(this.seconds/60)},get format(){return prependZeros(this.m)+":"+prependZeros(this.s)}};n.structureText=`Instruments: ${JSON.stringify(e.instruments,null,4)}

`,n.overviews=[["NBS version",e.nbsVersion],["Song name",e.name],["Song author",e.author],["Song description",e.description],["Song tick length",e.size],["Song duration",t.format],["Total layers",e.layers.length],["Custom instruments",e.instruments.map(t=>t.builtIn?null:t.name).filter(Boolean).join(", ")]];const o=[];n.structureText=n.structureText.concat("Song: ",JSON.stringify(e,(t,n)=>{if("object"==typeof n&&null!==n){if("instrument"===t)return`[${t} ${n.name}]`;if("song"===t)return"[this]";if(o.includes(n))return`[${t}]`;o.push(n)}return n},4)),postMessage(n)});