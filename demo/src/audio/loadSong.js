import{getElements,getLoadedInstruments,getSong,pushLoadedInstruments,setInstruments}from"../util/globals.js";import{decodeAudioData}from"./audio.js";import{displayProgress}from"../util/util.js";class Instrument extends NBSjs.Instrument{audioBuffer="";constructor(e,t,n){super(e,t,n),void 0!==n&&(this.audioSrc=n.audioSrc||"")}}async function loadSong(e){var t=performance.now(),e=NBSjs.Song.fromArrayBuffer(await e.file.arrayBuffer());return{song:e,loadTime:performance.now()-t,structureText:JSON.stringify(e,void 0,4)}}function generateOverviews(e,t){var n={seconds:e.timePerTick*e.size/1e3,get s(){return(this.seconds%60).toFixed(2)},get m(){return Math.floor(this.seconds/60)},get format(){return prependZeros(this.m)+":"+prependZeros(this.s)}};const s=[];if(t)for(var[r,o]of t)s.push(o.name);return[["NBS version",e.nbsVersion],["Song name",e.name],["Song author",e.author],["Song description",e.description],["Song tick length",e.size],["Song duration",n.format],["Total layers",e.layers.length],["Custom instruments",e.instruments.map(e=>e.builtIn?null:e.name).filter(Boolean).join(", ")],["Available instruments",s.join(", ")]]}async function prepareSong(){displayProgress("Loading instruments...");const n=getLoadedInstruments()||new Map;var s=getSong().instruments,e=s.length;const r=new Map;for(let t=0;t<e;t++){const a=s[t];let e=!1;if(!a.audioBuffer){var o=n.get(a.audioSrc);if(o)a.audioBuffer=o;else if(a.builtIn){const i=await fetch(a.audioSrc);o=await i.arrayBuffer();a.audioBuffer=await decodeAudioData(o),pushLoadedInstruments(a.audioSrc,o)}else e=!0}e||r.set(a.name,a)}setInstruments(r),getElements().toggle.playback.looping.disabled=!getSong().loopEnabled,getElements().toggle.playback.looping.checked=getSong().loopEnabled}function prependZeros(e){return Array.from({length:Math.max(3-Math.floor(e).toString().length,0)}).join("0")+e}Instrument.builtIn=[new Instrument("Harp",0,{audioSrc:"assets/harp.mp3",builtIn:!0,pressKey:!0}),new Instrument("Double Bass",1,{audioSrc:"assets/dbass.mp3",builtIn:!0}),new Instrument("Bass Drum",2,{audioSrc:"assets/bdrum.mp3",builtIn:!0}),new Instrument("Snare Drum",3,{audioSrc:"assets/sdrum.mp3",builtIn:!0}),new Instrument("Click",4,{audioSrc:"assets/click.mp3",builtIn:!0}),new Instrument("Guitar",5,{audioSrc:"assets/guitar.mp3",builtIn:!0}),new Instrument("Flute",6,{audioSrc:"assets/flute.mp3",builtIn:!0}),new Instrument("Bell",7,{audioSrc:"assets/bell.mp3",builtIn:!0}),new Instrument("Chime",8,{audioSrc:"assets/chime.mp3",builtIn:!0}),new Instrument("Xylophone",9,{audioSrc:"assets/xylophone.mp3",builtIn:!0}),new Instrument("Iron Xylophone",10,{audioSrc:"assets/iron_xylophone.mp3",builtIn:!0}),new Instrument("Cow Bell",11,{audioSrc:"assets/cow_bell.mp3",builtIn:!0}),new Instrument("Didgeridoo",12,{audioSrc:"assets/didgeridoo.mp3",builtIn:!0}),new Instrument("Bit",13,{audioSrc:"assets/bit.mp3",builtIn:!0}),new Instrument("Banjo",14,{audioSrc:"assets/banjo.mp3",builtIn:!0}),new Instrument("Pling",15,{audioSrc:"assets/pling.mp3",builtIn:!0})],NBSjs.setInstrumentClass(Instrument);export{loadSong,generateOverviews,prepareSong};